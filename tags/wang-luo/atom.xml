<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
    <title>xsro&#x27;s blog - 网络</title>
    <link rel="self" type="application/atom+xml" href="https://xsro.github.io/tags/wang-luo/atom.xml"/>
    <link rel="alternate" type="text/html" href="https://xsro.github.io"/>
    <generator uri="https://www.getzola.org/">Zola</generator>
    <updated>2022-02-09T00:00:00+00:00</updated>
    <id>https://xsro.github.io/tags/wang-luo/atom.xml</id>
    <entry xml:lang="en">
        <title>借助Termux在安卓手机上运行Clash代理服务</title>
        <published>2022-02-09T00:00:00+00:00</published>
        <updated>2022-02-09T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Unknown
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://xsro.github.io/backup/iot-termux-clash/"/>
        <id>https://xsro.github.io/backup/iot-termux-clash/</id>
        
        <content type="html" xml:base="https://xsro.github.io/backup/iot-termux-clash/">&lt;h1 id=&quot;zai-termux-zhong-bu-shu-clash-bing-shi-xian-pang-lu-you&quot;&gt;在 Termux 中部署 Clash 并实现旁路由&lt;&#x2F;h1&gt;
&lt;p&gt;魅族提供了 root 权限，但是开启之后就意味着放弃以后官方维护的可能性了。
经过几天的折腾，我吧我的魅蓝 6（人生第一部手机）作为家庭软路由，满足一些上网需求。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;xiang-guan-gong-ju-de-guan-wang-jie-shao&quot;&gt;相关工具的官网介绍&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;termux.com&quot;&gt;Termux&lt;&#x2F;a&gt;: an Android terminal emulator and Linux environment app that works directly with no rooting or setup required. A minimal base system is installed automatically - additional packages are available using the APT package manager.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Dreamacro&#x2F;clash&quot;&gt;Clash&lt;&#x2F;a&gt;: A rule-based tunnel in Go.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Dreamacro&#x2F;clash-dashboard&quot;&gt;Clash Dashboard&lt;&#x2F;a&gt;: Web Dashboard for Clash, now host on ClashX&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;gong-ju-an-zhuang&quot;&gt;工具安装&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;an-zhuang-termux&quot;&gt;安装 Termux&lt;&#x2F;h3&gt;
&lt;p&gt;官方推荐从&lt;a href=&quot;https:&#x2F;&#x2F;f-droid.org&#x2F;packages&#x2F;com.termux&#x2F;&quot;&gt;F-Droid&lt;&#x2F;a&gt;中安装 Termux，
可以直接在网页中下载 APK 文件进行安装，也可以安装 F-Droid 以方便及时更新。
在完成 termux 安装之后最好先运行&lt;code&gt;termux-change-repo&lt;&#x2F;code&gt;来&lt;a href=&quot;https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;help&#x2F;termux&#x2F;&quot;&gt;切换软件源&lt;&#x2F;a&gt;，这样之后的下载工作会方便很多。
为了方便可以在手机上运行 sshd 服务，从而实现在电脑上远程登录。&lt;&#x2F;p&gt;
&lt;h3 id=&quot;an-zhuang-clash&quot;&gt;安装 clash&lt;&#x2F;h3&gt;
&lt;p&gt;官方提供了 clash 的安装包，你可能需要&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;pkg&lt;&#x2F;span&gt;&lt;span&gt; install clash
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;运行 clash 代理需要一个 clash 配置文件，通常是一个 yaml 文件。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;clash -f &lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;配置文件本地地址&amp;gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;终端会打印出相应服务运行所在的端口，包括 RESTful API，HTTP 代理，SOCKS 代理端口，
例如以下信息：&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;plainText&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-plainText &quot;&gt;&lt;code class=&quot;language-plainText&quot; data-lang=&quot;plainText&quot;&gt;&lt;span&gt;INFO[0000] RESTful API listening at = [::]:9090
&lt;&#x2F;span&gt;&lt;span&gt;INFO[0000] HTTP proxy listening at = [::]:7890
&lt;&#x2F;span&gt;&lt;span&gt;INFO[0000] SOCKS proxy listening at = [::]:7891
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;还需要知道自己设备的端口，通常进入手机的 wifi 设置中可以看到自己手机在局域网中的 wifi 地址，
可以在 termux 中输入&lt;code&gt;ip addr&lt;&#x2F;code&gt;查看，以下命令可能可以帮助查找：&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;ip&lt;&#x2F;span&gt;&lt;span&gt; addr | &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;grep -Eo &lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;192.[0-9]+.[0-9]+.[0-9]+&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;head -1
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;比如我的 ip 地址是&lt;code&gt;192.168.0.102&lt;&#x2F;code&gt;，可以到路由器中将 ip 设置为固定 ip（似乎也叫静态 ip，或者叫与 mac 绑定）。
也可以在手机中将 IP 设置（通常为 DHCP）改为静态并手动设置 IP。
这个 ip 地址就是我们运行代理服务的代理服务器地址。&lt;&#x2F;p&gt;
&lt;h3 id=&quot;guan-li-clash&quot;&gt;管理 clash&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Dreamacro&#x2F;clash-dashboard&quot;&gt;clash-dashboard&lt;&#x2F;a&gt;和&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;haishanh&#x2F;yacd&quot;&gt;yacd&lt;&#x2F;a&gt;是目前主要的两个 clash 管理程序，都是 vue 程序。
可以直接在网站&lt;a href=&quot;http:&#x2F;&#x2F;clash.razord.top&#x2F;&quot;&gt;clash-dashboard&lt;&#x2F;a&gt;和&lt;a href=&quot;http:&#x2F;&#x2F;yacd.haishan.me&#x2F;&quot;&gt;yacd&lt;&#x2F;a&gt;使用，使用的时候填入运行 clash 时设置的&lt;code&gt;external-controller&lt;&#x2F;code&gt;（配置文件中）或者&lt;code&gt;-ext-ctl&lt;&#x2F;code&gt;（命令行）地址即可。&lt;&#x2F;p&gt;
&lt;p&gt;另外，clash 提供了&lt;code&gt;-ext-ui&lt;&#x2F;code&gt;（命令行）或&lt;code&gt;external-ui&lt;&#x2F;code&gt;（配置文件）选项，可以本地部署这两个 app。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;git&lt;&#x2F;span&gt;&lt;span&gt; clone&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -b&lt;&#x2F;span&gt;&lt;span&gt; gh-pages https:&#x2F;&#x2F;github.com&#x2F;Dreamacro&#x2F;clash-dashboard.git
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;克隆完成之后，
可以使用通过 clash 的&lt;code&gt;-ext-ui&lt;&#x2F;code&gt;参数来将构建好的 web 应用托管到网络中。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;clash -f &lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;配置文件本地地址&amp;gt; -ext-ui &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;clash-dashboard&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;在浏览器中打开&lt;code&gt;&amp;lt;ip地址&amp;gt;:&amp;lt;RESTful Api端口号&amp;gt;&#x2F;ui&lt;&#x2F;code&gt;,就应该可以看到管理面板了，在打开的界面中填入 clash 服务的 ip 地址和 RESTful API 的端口号即可，即可进行控制。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;&#x2F;images&#x2F;clash-dashboard-config.png&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;tong-guo-dai-li-gong-xiang&quot;&gt;通过代理共享&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;windows-she-zhi-xi-tong-dai-li&quot;&gt;windows 设置系统代理&lt;&#x2F;h3&gt;
&lt;p&gt;（我使用的是 win10）进入&lt;code&gt;设置&lt;&#x2F;code&gt;，&lt;code&gt;网络与Internet&lt;&#x2F;code&gt;，选择&lt;strong&gt;代理&lt;&#x2F;strong&gt;，在&lt;strong&gt;手动设置代理&lt;&#x2F;strong&gt;中填入代理服务器地址和端口，打开&lt;strong&gt;使用代理服务器&lt;&#x2F;strong&gt;。&lt;&#x2F;p&gt;
&lt;h3 id=&quot;mac-she-zhi-wifi-dai-li&quot;&gt;mac 设置 WiFi 代理&lt;&#x2F;h3&gt;
&lt;p&gt;打开&lt;code&gt;设置&lt;&#x2F;code&gt;，进入&lt;code&gt;网络&lt;&#x2F;code&gt;，在 Wi-Fi 中选择高级，进入&lt;strong&gt;代理&lt;&#x2F;strong&gt;选项卡，在网页代理(HTTP)、安全网页代理(HTTPS)、SOCKS 代理中填入相应的代理服务器地址和端口，并应用。&lt;strong&gt;忽略这些主机与域的代理设置&lt;&#x2F;strong&gt;中可以设置如下内容&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;plainText&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-plainText &quot;&gt;&lt;code class=&quot;language-plainText&quot; data-lang=&quot;plainText&quot;&gt;&lt;span&gt;192.168.0.0&#x2F;16、10.0.0.0&#x2F;8、172.16.0.0&#x2F;12、127.0.0.1、localhost、*.local、timestamp.apple.com、*.cn
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;an-zhuo-she-zhi-wifi-dai-li&quot;&gt;安卓设置 WiFi 代理&lt;&#x2F;h3&gt;
&lt;p&gt;（我使用的 MIUI12）进入 Wi-Fi，点击连接的 Wifi，下滑在&lt;code&gt;代理&lt;&#x2F;code&gt;中选择手动，主机名填入代理服务器地址，端口填写 http 代理服务端口。
如果想代理手机中的所有用户的流量，应该考虑通过 vpn，如使用软件&lt;a href=&quot;https:&#x2F;&#x2F;play.google.com&#x2F;store&#x2F;apps&#x2F;details?id=net.typeblog.socks&quot;&gt;SocksDroid&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;pang-lu-you&quot;&gt;旁路由&lt;&#x2F;h2&gt;
&lt;p&gt;旁路由需要再 root 权限下运行 clash，我摸索着实现了，这里仅仅简要记录，建议参看相关链接。&lt;&#x2F;p&gt;
&lt;h3 id=&quot;xiu-gai-pei-zhi-wen-jian&quot;&gt;修改配置文件&lt;&#x2F;h3&gt;
&lt;p&gt;将配置文件做如下修改，参考自&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hackl0us&#x2F;SS-Rule-Snippet&quot;&gt;Hackl0us&#x2F;SS-Rule-Snippet&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;redir-port = 7895 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;#透明代理端口
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;dns&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;enable = true
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;listen = 0.0.0.0:8053 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;#dns运行的端口
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;ipv6 = true
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;default-nameserver&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;223.5.5.5
&lt;&#x2F;span&gt;&lt;span&gt;    - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;114.114.114.114
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;enhanced-mode = fake-ip
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;fake-ip-range = 198.18.0.1&#x2F;16 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;#fake-ip 范围
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;nameserver&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;https:&#x2F;&#x2F;doh.pub&#x2F;dns-query
&lt;&#x2F;span&gt;&lt;span&gt;    - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;https:&#x2F;&#x2F;dns.alidns.com&#x2F;dns-query
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fallback-filter&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;geoip = false
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;ipcidr&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;240.0.0.0&#x2F;4
&lt;&#x2F;span&gt;&lt;span&gt;      - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;0.0.0.0&#x2F;32
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;she-zhi-iptables-rang-shou-ji-zuo-wei-wang-guan&quot;&gt;设置 iptables 让手机作为网关&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;## 参考自 https:&#x2F;&#x2F;jiajunhuang.com&#x2F;articles&#x2F;2022_11_20-router.md.html
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;dnsport&lt;&#x2F;span&gt;&lt;span&gt;=&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;8053&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;#dns运行所在端口
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;redirport&lt;&#x2F;span&gt;&lt;span&gt;=&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;7895&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;#透明代理端口
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fakeip&lt;&#x2F;span&gt;&lt;span&gt;=&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;198.18.0.0&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;#fake-ip范围
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;router&lt;&#x2F;span&gt;&lt;span&gt;=&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;192.168.1.6&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;#旁路由地址，即为手机ip地址
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# ENABLE ipv4 forward
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;sysctl -w&lt;&#x2F;span&gt;&lt;span&gt; net.ipv4.ip_forward=1
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# 转发所有 DNS 查询到 8053 端口
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# 此操作会导致所有 DNS 请求全部返回虚假 IP(fake ip 198.18.0.1&#x2F;16)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -I&lt;&#x2F;span&gt;&lt;span&gt; PREROUTING&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -p&lt;&#x2F;span&gt;&lt;span&gt; udp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; --dport&lt;&#x2F;span&gt;&lt;span&gt; 53&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; REDIRECT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; --to &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;dnsport
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# 这个是fake-ip对应的dns地址，一般不用动
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; PREROUTING&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -p&lt;&#x2F;span&gt;&lt;span&gt; tcp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; --dport &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;dnsport -d &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fakeip&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;24&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; clash_dns
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; PREROUTING&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -p&lt;&#x2F;span&gt;&lt;span&gt; udp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; --dport &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;dnsport -d &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fakeip&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;24&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; clash_dns
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; PREROUTING&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -p&lt;&#x2F;span&gt;&lt;span&gt; tcp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; clash
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# 让当前机器成为一个网关服务器
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; filter&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; FORWARD&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; ACCEPT
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; POSTROUTING&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -s&lt;&#x2F;span&gt;&lt;span&gt; 192.168.0.0&#x2F;16&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; MASQUERADE
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -N&lt;&#x2F;span&gt;&lt;span&gt; clash
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -N&lt;&#x2F;span&gt;&lt;span&gt; clash_dns
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# 这里需要注意的是，下面两行最后的 192.168.1.21 是当前旁路由的 IP 地址，请根据你自己的实际情况修改
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# 目的DNS端口是后面clash配置里面的5354
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash_dns&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -p&lt;&#x2F;span&gt;&lt;span&gt; udp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; --dport &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;dnsport -d &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fakeip&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;24&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; DNAT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; --to-destination &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;router&lt;&#x2F;span&gt;&lt;span&gt;:$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;dnsport
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash_dns&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -p&lt;&#x2F;span&gt;&lt;span&gt; tcp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; --dport &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;dnsport -d &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fakeip&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;24&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; DNAT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; --to-destination &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;router&lt;&#x2F;span&gt;&lt;span&gt;:$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;dnsport
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# 绕过一些内网地址，（RETURN 表示退出当前Chain，返回到上一级的Chain继续匹配）
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -d&lt;&#x2F;span&gt;&lt;span&gt; 0.0.0.0&#x2F;8&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; RETURN
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -d&lt;&#x2F;span&gt;&lt;span&gt; 10.0.0.0&#x2F;8&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; RETURN
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -d&lt;&#x2F;span&gt;&lt;span&gt; 127.0.0.0&#x2F;8&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; RETURN
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -d&lt;&#x2F;span&gt;&lt;span&gt; 169.254.0.0&#x2F;16&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; RETURN
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -d&lt;&#x2F;span&gt;&lt;span&gt; 172.16.0.0&#x2F;12&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; RETURN
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -d&lt;&#x2F;span&gt;&lt;span&gt; 192.168.0.0&#x2F;16&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; RETURN
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -d&lt;&#x2F;span&gt;&lt;span&gt; 224.0.0.0&#x2F;4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; RETURN
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -d&lt;&#x2F;span&gt;&lt;span&gt; 240.0.0.0&#x2F;4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; RETURN
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# 注意, 这边的7892对应后续clash配置里的redir-port
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;iptables -t&lt;&#x2F;span&gt;&lt;span&gt; nat&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; clash&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -p&lt;&#x2F;span&gt;&lt;span&gt; tcp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -j&lt;&#x2F;span&gt;&lt;span&gt; REDIRECT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; --to-ports &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;redirport
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
</content>
        
    </entry>
</feed>
