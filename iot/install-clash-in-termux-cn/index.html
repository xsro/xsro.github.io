<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      
    

      <title>xsro&#x27;s blog - 借助Termux在安卓手机上运行Clash代理服务</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">

          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js" integrity="sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy" crossorigin="anonymous"></script>
              
          
      

      
          <link rel="stylesheet" href="https://xsro.github.io/site.css">
          
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">光侨路笔记</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;xsro.github.io">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;xsro.github.io&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;xsro.github.io&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;xsro.github.io&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;xsro.github.io">光侨路笔记</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;xsro.github.io">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;xsro.github.io&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;xsro.github.io&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;xsro.github.io&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://xsro.github.io/iot/install-clash-in-termux-cn/#zai-termux-zhong-bu-shu-clash-bing-shi-xian-pang-lu-you" class="toc-link">在 Termux 中部署 Clash 并实现旁路由</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://xsro.github.io/iot/install-clash-in-termux-cn/#xiang-guan-gong-ju-de-guan-wang-jie-shao" class="toc-link">相关工具的官网介绍</a>
                        </li>
                        
                        <li>
                            <a href="https://xsro.github.io/iot/install-clash-in-termux-cn/#gong-ju-an-zhuang" class="toc-link">工具安装</a>
                        </li>
                        
                        <li>
                            <a href="https://xsro.github.io/iot/install-clash-in-termux-cn/#tong-guo-dai-li-gong-xiang" class="toc-link">通过代理共享</a>
                        </li>
                        
                        <li>
                            <a href="https://xsro.github.io/iot/install-clash-in-termux-cn/#pang-lu-you" class="toc-link">旁路由</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;xsro.github.io&#x2F;iot&#x2F;install-clash-in-termux-cn&#x2F;">借助Termux在安卓手机上运行Clash代理服务</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2022-02-09</span>
            
        </div>
    </header>

    <div class="post-content">
      <h1 id="zai-termux-zhong-bu-shu-clash-bing-shi-xian-pang-lu-you">在 Termux 中部署 Clash 并实现旁路由</h1>
<p>魅族提供了 root 权限，但是开启之后就意味着放弃以后官方维护的可能性了。
经过几天的折腾，我吧我的魅蓝 6（人生第一部手机）作为家庭软路由，满足一些上网需求。</p>
<h2 id="xiang-guan-gong-ju-de-guan-wang-jie-shao">相关工具的官网介绍</h2>
<ul>
<li><a href="https://termux.com">Termux</a>: an Android terminal emulator and Linux environment app that works directly with no rooting or setup required. A minimal base system is installed automatically - additional packages are available using the APT package manager.</li>
<li><a href="https://github.com/Dreamacro/clash">Clash</a>: A rule-based tunnel in Go.</li>
<li><a href="https://github.com/Dreamacro/clash-dashboard">Clash Dashboard</a>: Web Dashboard for Clash, now host on ClashX</li>
</ul>
<h2 id="gong-ju-an-zhuang">工具安装</h2>
<h3 id="an-zhuang-termux">安装 Termux</h3>
<p>官方推荐从<a href="https://f-droid.org/packages/com.termux/">F-Droid</a>中安装 Termux，
可以直接在网页中下载 APK 文件进行安装，也可以安装 F-Droid 以方便及时更新。
在完成 termux 安装之后最好先运行<code>termux-change-repo</code>来<a href="https://mirrors.tuna.tsinghua.edu.cn/help/termux/">切换软件源</a>，这样之后的下载工作会方便很多。
为了方便可以在手机上运行 sshd 服务，从而实现在电脑上远程登录。</p>
<h3 id="an-zhuang-clash">安装 clash</h3>
<p>官方提供了 clash 的安装包，你可能需要</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">pkg</span><span> install clash
</span></code></pre>
<p>运行 clash 代理需要一个 clash 配置文件，通常是一个 yaml 文件。</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">clash -f </span><span>&lt;配置文件本地地址&gt;
</span></code></pre>
<p>终端会打印出相应服务运行所在的端口，包括 RESTful API，HTTP 代理，SOCKS 代理端口，
例如以下信息：</p>
<pre data-lang="plainText" style="background-color:#2b303b;color:#c0c5ce;" class="language-plainText "><code class="language-plainText" data-lang="plainText"><span>INFO[0000] RESTful API listening at = [::]:9090
</span><span>INFO[0000] HTTP proxy listening at = [::]:7890
</span><span>INFO[0000] SOCKS proxy listening at = [::]:7891
</span></code></pre>
<p>还需要知道自己设备的端口，通常进入手机的 wifi 设置中可以看到自己手机在局域网中的 wifi 地址，
可以在 termux 中输入<code>ip addr</code>查看，以下命令可能可以帮助查找：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">ip</span><span> addr | </span><span style="color:#bf616a;">grep -Eo </span><span>&#39;</span><span style="color:#a3be8c;">192.[0-9]+.[0-9]+.[0-9]+</span><span>&#39;|</span><span style="color:#bf616a;">head -1
</span></code></pre>
<p>比如我的 ip 地址是<code>192.168.0.102</code>，可以到路由器中将 ip 设置为固定 ip（似乎也叫静态 ip，或者叫与 mac 绑定）。
也可以在手机中将 IP 设置（通常为 DHCP）改为静态并手动设置 IP。
这个 ip 地址就是我们运行代理服务的代理服务器地址。</p>
<h3 id="guan-li-clash">管理 clash</h3>
<p><a href="https://github.com/Dreamacro/clash-dashboard">clash-dashboard</a>和<a href="https://github.com/haishanh/yacd">yacd</a>是目前主要的两个 clash 管理程序，都是 vue 程序。
可以直接在网站<a href="http://clash.razord.top/">clash-dashboard</a>和<a href="http://yacd.haishan.me/">yacd</a>使用，使用的时候填入运行 clash 时设置的<code>external-controller</code>（配置文件中）或者<code>-ext-ctl</code>（命令行）地址即可。</p>
<p>另外，clash 提供了<code>-ext-ui</code>（命令行）或<code>external-ui</code>（配置文件）选项，可以本地部署这两个 app。</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">git</span><span> clone</span><span style="color:#bf616a;"> -b</span><span> gh-pages https://github.com/Dreamacro/clash-dashboard.git
</span></code></pre>
<p>克隆完成之后，
可以使用通过 clash 的<code>-ext-ui</code>参数来将构建好的 web 应用托管到网络中。</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">clash -f </span><span>&lt;配置文件本地地址&gt; -ext-ui &quot;</span><span style="color:#a3be8c;">clash-dashboard</span><span>&quot;
</span></code></pre>
<p>在浏览器中打开<code>&lt;ip地址&gt;:&lt;RESTful Api端口号&gt;/ui</code>,就应该可以看到管理面板了，在打开的界面中填入 clash 服务的 ip 地址和 RESTful API 的端口号即可，即可进行控制。</p>
<p><img src="/images/clash-dashboard-config.png" alt="" /></p>
<h2 id="tong-guo-dai-li-gong-xiang">通过代理共享</h2>
<h3 id="windows-she-zhi-xi-tong-dai-li">windows 设置系统代理</h3>
<p>（我使用的是 win10）进入<code>设置</code>，<code>网络与Internet</code>，选择<strong>代理</strong>，在<strong>手动设置代理</strong>中填入代理服务器地址和端口，打开<strong>使用代理服务器</strong>。</p>
<h3 id="mac-she-zhi-wifi-dai-li">mac 设置 WiFi 代理</h3>
<p>打开<code>设置</code>，进入<code>网络</code>，在 Wi-Fi 中选择高级，进入<strong>代理</strong>选项卡，在网页代理(HTTP)、安全网页代理(HTTPS)、SOCKS 代理中填入相应的代理服务器地址和端口，并应用。<strong>忽略这些主机与域的代理设置</strong>中可以设置如下内容</p>
<pre data-lang="plainText" style="background-color:#2b303b;color:#c0c5ce;" class="language-plainText "><code class="language-plainText" data-lang="plainText"><span>192.168.0.0/16、10.0.0.0/8、172.16.0.0/12、127.0.0.1、localhost、*.local、timestamp.apple.com、*.cn
</span></code></pre>
<h3 id="an-zhuo-she-zhi-wifi-dai-li">安卓设置 WiFi 代理</h3>
<p>（我使用的 MIUI12）进入 Wi-Fi，点击连接的 Wifi，下滑在<code>代理</code>中选择手动，主机名填入代理服务器地址，端口填写 http 代理服务端口。
如果想代理手机中的所有用户的流量，应该考虑通过 vpn，如使用软件<a href="https://play.google.com/store/apps/details?id=net.typeblog.socks">SocksDroid</a></p>
<h2 id="pang-lu-you">旁路由</h2>
<p>旁路由需要再 root 权限下运行 clash，我摸索着实现了，这里仅仅简要记录，建议参看相关链接。</p>
<h3 id="xiu-gai-pei-zhi-wen-jian">修改配置文件</h3>
<p>将配置文件做如下修改，参考自<a href="https://github.com/Hackl0us/SS-Rule-Snippet">Hackl0us/SS-Rule-Snippet</a></p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#a3be8c;">redir-port = 7895 </span><span style="color:#65737e;">#透明代理端口
</span><span style="color:#bf616a;">dns</span><span>:
</span><span>  </span><span style="color:#a3be8c;">enable = true
</span><span>  </span><span style="color:#a3be8c;">listen = 0.0.0.0:8053 </span><span style="color:#65737e;">#dns运行的端口
</span><span>  </span><span style="color:#a3be8c;">ipv6 = true
</span><span>  </span><span style="color:#bf616a;">default-nameserver</span><span>:
</span><span>    - </span><span style="color:#d08770;">223.5.5.5
</span><span>    - </span><span style="color:#d08770;">114.114.114.114
</span><span>  </span><span style="color:#a3be8c;">enhanced-mode = fake-ip
</span><span>  </span><span style="color:#a3be8c;">fake-ip-range = 198.18.0.1/16 </span><span style="color:#65737e;">#fake-ip 范围
</span><span>  </span><span style="color:#bf616a;">nameserver</span><span>:
</span><span>    - </span><span style="color:#a3be8c;">https://doh.pub/dns-query
</span><span>    - </span><span style="color:#a3be8c;">https://dns.alidns.com/dns-query
</span><span>  </span><span style="color:#bf616a;">fallback-filter</span><span>:
</span><span>    </span><span style="color:#a3be8c;">geoip = false
</span><span>    </span><span style="color:#bf616a;">ipcidr</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">240.0.0.0/4
</span><span>      - </span><span style="color:#a3be8c;">0.0.0.0/32
</span></code></pre>
<h3 id="she-zhi-iptables-rang-shou-ji-zuo-wei-wang-guan">设置 iptables 让手机作为网关</h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#65737e;">## 参考自 https://jiajunhuang.com/articles/2022_11_20-router.md.html
</span><span>
</span><span style="color:#bf616a;">dnsport</span><span>=&quot;</span><span style="color:#a3be8c;">8053</span><span>&quot; </span><span style="color:#65737e;">#dns运行所在端口
</span><span style="color:#bf616a;">redirport</span><span>=&quot;</span><span style="color:#a3be8c;">7895</span><span>&quot; </span><span style="color:#65737e;">#透明代理端口
</span><span style="color:#bf616a;">fakeip</span><span>=&quot;</span><span style="color:#a3be8c;">198.18.0.0</span><span>&quot; </span><span style="color:#65737e;">#fake-ip范围
</span><span style="color:#bf616a;">router</span><span>=&quot;</span><span style="color:#a3be8c;">192.168.1.6</span><span>&quot; </span><span style="color:#65737e;">#旁路由地址，即为手机ip地址
</span><span>
</span><span style="color:#65737e;"># ENABLE ipv4 forward
</span><span style="color:#bf616a;">sysctl -w</span><span> net.ipv4.ip_forward=1
</span><span>
</span><span style="color:#65737e;"># 转发所有 DNS 查询到 8053 端口
</span><span style="color:#65737e;"># 此操作会导致所有 DNS 请求全部返回虚假 IP(fake ip 198.18.0.1/16)
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -I</span><span> PREROUTING</span><span style="color:#bf616a;"> -p</span><span> udp</span><span style="color:#bf616a;"> --dport</span><span> 53</span><span style="color:#bf616a;"> -j</span><span> REDIRECT</span><span style="color:#bf616a;"> --to </span><span>$</span><span style="color:#bf616a;">dnsport
</span><span>
</span><span style="color:#65737e;"># 这个是fake-ip对应的dns地址，一般不用动
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> PREROUTING</span><span style="color:#bf616a;"> -p</span><span> tcp</span><span style="color:#bf616a;"> --dport </span><span>$</span><span style="color:#bf616a;">dnsport -d </span><span>$</span><span style="color:#bf616a;">fakeip</span><span>/24</span><span style="color:#bf616a;"> -j</span><span> clash_dns
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> PREROUTING</span><span style="color:#bf616a;"> -p</span><span> udp</span><span style="color:#bf616a;"> --dport </span><span>$</span><span style="color:#bf616a;">dnsport -d </span><span>$</span><span style="color:#bf616a;">fakeip</span><span>/24</span><span style="color:#bf616a;"> -j</span><span> clash_dns
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> PREROUTING</span><span style="color:#bf616a;"> -p</span><span> tcp</span><span style="color:#bf616a;"> -j</span><span> clash
</span><span>
</span><span style="color:#65737e;"># 让当前机器成为一个网关服务器
</span><span style="color:#bf616a;">iptables -t</span><span> filter</span><span style="color:#bf616a;"> -A</span><span> FORWARD</span><span style="color:#bf616a;"> -j</span><span> ACCEPT
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> POSTROUTING</span><span style="color:#bf616a;"> -s</span><span> 192.168.0.0/16</span><span style="color:#bf616a;"> -j</span><span> MASQUERADE
</span><span>
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -N</span><span> clash
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -N</span><span> clash_dns
</span><span>
</span><span style="color:#65737e;"># 这里需要注意的是，下面两行最后的 192.168.1.21 是当前旁路由的 IP 地址，请根据你自己的实际情况修改
</span><span style="color:#65737e;"># 目的DNS端口是后面clash配置里面的5354
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash_dns</span><span style="color:#bf616a;"> -p</span><span> udp</span><span style="color:#bf616a;"> --dport </span><span>$</span><span style="color:#bf616a;">dnsport -d </span><span>$</span><span style="color:#bf616a;">fakeip</span><span>/24</span><span style="color:#bf616a;"> -j</span><span> DNAT</span><span style="color:#bf616a;"> --to-destination </span><span>$</span><span style="color:#bf616a;">router</span><span>:$</span><span style="color:#bf616a;">dnsport
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash_dns</span><span style="color:#bf616a;"> -p</span><span> tcp</span><span style="color:#bf616a;"> --dport </span><span>$</span><span style="color:#bf616a;">dnsport -d </span><span>$</span><span style="color:#bf616a;">fakeip</span><span>/24</span><span style="color:#bf616a;"> -j</span><span> DNAT</span><span style="color:#bf616a;"> --to-destination </span><span>$</span><span style="color:#bf616a;">router</span><span>:$</span><span style="color:#bf616a;">dnsport
</span><span>
</span><span style="color:#65737e;"># 绕过一些内网地址，（RETURN 表示退出当前Chain，返回到上一级的Chain继续匹配）
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash</span><span style="color:#bf616a;"> -d</span><span> 0.0.0.0/8</span><span style="color:#bf616a;"> -j</span><span> RETURN
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash</span><span style="color:#bf616a;"> -d</span><span> 10.0.0.0/8</span><span style="color:#bf616a;"> -j</span><span> RETURN
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash</span><span style="color:#bf616a;"> -d</span><span> 127.0.0.0/8</span><span style="color:#bf616a;"> -j</span><span> RETURN
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash</span><span style="color:#bf616a;"> -d</span><span> 169.254.0.0/16</span><span style="color:#bf616a;"> -j</span><span> RETURN
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash</span><span style="color:#bf616a;"> -d</span><span> 172.16.0.0/12</span><span style="color:#bf616a;"> -j</span><span> RETURN
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash</span><span style="color:#bf616a;"> -d</span><span> 192.168.0.0/16</span><span style="color:#bf616a;"> -j</span><span> RETURN
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash</span><span style="color:#bf616a;"> -d</span><span> 224.0.0.0/4</span><span style="color:#bf616a;"> -j</span><span> RETURN
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash</span><span style="color:#bf616a;"> -d</span><span> 240.0.0.0/4</span><span style="color:#bf616a;"> -j</span><span> RETURN
</span><span>
</span><span style="color:#65737e;"># 注意, 这边的7892对应后续clash配置里的redir-port
</span><span style="color:#bf616a;">iptables -t</span><span> nat</span><span style="color:#bf616a;"> -A</span><span> clash</span><span style="color:#bf616a;"> -p</span><span> tcp</span><span style="color:#bf616a;"> -j</span><span> REDIRECT</span><span style="color:#bf616a;"> --to-ports </span><span>$</span><span style="color:#bf616a;">redirport
</span></code></pre>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://xsro.github.io/tags/iot/">#IoT</a>
                    
                        <a href="https://xsro.github.io/tags/wang-luo/">#网络</a>
                    
                </div>
            
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https://xsro.github.io/even.js" ></script>
      
    </body>

</html>
